FROM node:20-alpine AS build
WORKDIR /app
RUN apk add --no-cache python3 make g++ && corepack enable
COPY apps/web ./apps/web
WORKDIR /app/apps/web
RUN if [ -f pnpm-lock.yaml ]; then corepack prepare pnpm@9 --activate && pnpm i --frozen-lockfile;     elif [ -f yarn.lock ]; then corepack prepare yarn@4 --activate && yarn install --immutable;     elif [ -f package-lock.json ]; then npm ci; else npm i; fi
RUN npm run build

FROM node:20-alpine AS runtime
ENV NODE_ENV=production
ENV PORT=3000
ENV HOSTNAME=0.0.0.0
WORKDIR /app
COPY --from=build /app/apps/web/.next/standalone ./
COPY --from=build /app/apps/web/.next/static ./.next/static
COPY --from=build /app/apps/web/public ./public
EXPOSE 3000
CMD ["node", "server.js"]
